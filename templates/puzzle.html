{{ define "title" }}Puzzle - {{ .Puzzle.Name }}{{ end }}

{{ define "submission" }}
<tr data-id='{{ .Id.Hex }}'>
  <td>{{ .ReceivedAt.Format "15:04:05" }}</td>
  <td>{{ .Answer }} </td>
  <td>{{ .AnswerStatus }}</td>
</tr>
{{ end }}

{{ define "content" }}
  <h1><a href='{{ .Puzzle.Url }}'>{{ .Puzzle.Name }}</a></h1>
  <a href='/map'>All Puzzles</a>

  <form action="/map/puzzles/{{ .Puzzle.Slug }}" method='post'
        data-remote=true>
    <div>
      <label for='answer'>Answer:</label>
      <input type='text' id='answer' name='answer'/><br/>
      <input type='submit' value='Submit' data-disable-with='Submitting...'/>
    </div>
  </form>
  {{ if .Submissions }}
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Answer</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {{ range .Submissions }}
          {{ template "submission" . }}
        {{ end }}
      </tbody>
    </table>
  {{ end }}
  <script type='text/javascript'>
    $(function() {
      var ws = new WebSocket('ws://' + location.host + '/map/{{ .Tag }}/ws');
      ws.onclose = function(e) { console.log('close', e); };
      ws.onerror = function(e) { console.log('error', e); };
      ws.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.Type == 'new') {
          $('tbody').prepend(data.Html);
        } else {
          $('tr[data-id=' + data.Id + ']').replaceWith(data.Html);
        }
      };
      $('form').bind('ajax:complete', function() {
        $('#answer').val('');
      });
    });
  </script>
{{ end }}
